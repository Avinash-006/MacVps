name: MacRDP
on:
  workflow_dispatch:

jobs:
  build:
    name: MacRDP
    runs-on: macos-latest
    timeout-minutes: 60

    steps:
    - name: Enable VNC Remote Access
      run: |
        echo "üîß Enabling macOS Screen Sharing..."
        sudo systemsetup -setremotelogin on
        sudo launchctl load -w /System/Library/LaunchDaemons/com.apple.screensharing.plist
        sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/MacOS/ARDAgent -activate
        echo "‚úÖ Screen Sharing Enabled"

        echo "üîê Setting VNC password..."
        echo -n 'password' | perl -we 'print pack("H*", crypt(<STDIN>, "VN"))' > ~/.vncpwd
        sudo cp ~/.vncpwd /Library/Preferences/com.apple.VNCSettings.txt
        sudo chmod 600 /Library/Preferences/com.apple.VNCSettings.txt
        sudo defaults write /Library/Preferences/com.apple.RemoteManagement VNCOnly -bool true

    - name: Install Cloudflared
      run: |
        brew install cloudflared

    - name: Start Cloudflare Tunnel
      env:
        CF_TUNNEL_TOKEN: eyJhIjoiMjFlZmI3OGFmZWIxZTQyM2M3MDFkOWNkNjgzNjFhYTMiLCJ0IjoiMzE3ODk2ZjktYzU5OC00OGM4LWI5ZDItNzZkZjgxMDIwMjQ1IiwicyI6Ik4yTTRZV000WVRBdE1UWTNaQzAwWmpZNUxUbGhOV1l0WkdGallUZ3paV05pWmpJMiJ9
      run: |
        echo "üöÄ Starting Cloudflare Tunnel..."
        nohup cloudflared tunnel --no-autoupdate run --token "$CF_TUNNEL_TOKEN" > tunnel.log 2>&1 &
        echo "‚úÖ Tunnel started in background"

    - name: Show VNC Connection Info
      run: |
        echo "üéØ Connect with a VNC client to:"
        echo "URL: Use your Cloudflare public hostname (e.g. macos.example.cloudflareaccess.com)"
        echo "Port: 5900"
        echo "Password: password"

    - name: Keep VM Alive (Optional SSH or Debugging)
      uses: mxschmitt/action-tmate@v2
